<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }
        button { 
            padding: 15px 25px; 
            margin: 10px 5px; 
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #2196F3;
            color: white;
        }
        button:hover { background: #1976D2; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        #log { 
            background: #f5f5f5; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        #testData {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª å¿«é€’æ‰«ç åŠ©æ‰‹ - å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</h1>
    
    <div id="testData">
        <h3>ğŸ“Š æµ‹è¯•æ•°æ®</h3>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>å¿«é€’</th>
                    <th>åŸå§‹</th>
                    <th>å¤„ç†å</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- æµ‹è¯•æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </tbody>
        </table>
    </div>
    
    <div>
        <button onclick="generateTestData()">ğŸ“ ç”Ÿæˆæµ‹è¯•æ•°æ®</button>
        <button onclick="testBrowserDownload()">ğŸŒ æµ‹è¯•æµè§ˆå™¨ä¸‹è½½</button>
        <button onclick="testCapacitorExport()">ğŸ“± æµ‹è¯• Capacitor å¯¼å‡º</button>
        <button onclick="testEnvironment()">ğŸ” æ£€æµ‹ç¯å¢ƒ</button>
        <button onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>
    </div>
    
    <div id="log"></div>

    <script>
        let testRecords = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function generateTestData() {
            testRecords = [
                { time: '14:30:25', mode: 'UPS', orig: '1Z999AA1234567890', out: '1Z999AA1234567890' },
                { time: '14:31:10', mode: 'DHL', orig: '1234567890', out: '1234567890' },
                { time: '14:32:05', mode: 'FedEx', orig: '9876543210', out: '9876543210' },
                { time: '14:33:15', mode: 'é¡ºä¸°', orig: 'SF1234567890123', out: 'SF1234567890123' },
                { time: '14:34:20', mode: 'åœ†é€š', orig: 'YT9876543210987', out: 'YT9876543210987' }
            ];
            
            updateTable();
            log(`âœ… å·²ç”Ÿæˆ ${testRecords.length} æ¡æµ‹è¯•æ•°æ®`, 'success');
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            testRecords.forEach(record => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = record.time;
                row.insertCell(1).textContent = record.mode;
                row.insertCell(2).textContent = record.orig;
                row.insertCell(3).textContent = record.out;
            });
        }

        function testEnvironment() {
            log('ğŸ” å¼€å§‹ç¯å¢ƒæ£€æµ‹...');
            
            // åŸºæœ¬ç¯å¢ƒä¿¡æ¯
            log(`ğŸ“± ç”¨æˆ·ä»£ç†: ${navigator.userAgent}`);
            log(`ğŸŒ å¹³å°: ${navigator.platform}`);
            log(`ğŸ“Š å±å¹•å°ºå¯¸: ${screen.width}x${screen.height}`);
            
            // æ£€æµ‹ Capacitor
            if (window.Capacitor) {
                log('âœ… Capacitor ç¯å¢ƒå¯ç”¨', 'success');
                log(`ğŸ“¦ Capacitor å¹³å°: ${window.Capacitor.getPlatform()}`);
                log(`ğŸ  Capacitor åŸç”Ÿ: ${window.Capacitor.isNativePlatform()}`);
                
                if (window.Capacitor.Plugins) {
                    log('âœ… Capacitor Plugins å¯ç”¨', 'success');
                    
                    if (window.Capacitor.Plugins.FileManager) {
                        log('âœ… FileManager æ’ä»¶å·²åŠ è½½', 'success');
                    } else {
                        log('âŒ FileManager æ’ä»¶æœªæ‰¾åˆ°', 'error');
                    }
                    
                    if (window.Capacitor.Plugins.Filesystem) {
                        log('âœ… Filesystem æ’ä»¶å·²åŠ è½½', 'success');
                    } else {
                        log('âš ï¸ Filesystem æ’ä»¶æœªæ‰¾åˆ°', 'info');
                    }
                } else {
                    log('âŒ Capacitor Plugins ä¸å¯ç”¨', 'error');
                }
            } else {
                log('âŒ Capacitor ç¯å¢ƒä¸å¯ç”¨', 'error');
                log('â„¹ï¸ è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºåœ¨æµè§ˆå™¨ä¸­è¿è¡Œ', 'info');
            }
            
            // æ£€æµ‹ Web API
            if (typeof Blob !== 'undefined') {
                log('âœ… Blob API æ”¯æŒ', 'success');
            } else {
                log('âŒ Blob API ä¸æ”¯æŒ', 'error');
            }
            
            if (typeof URL !== 'undefined' && URL.createObjectURL) {
                log('âœ… URL.createObjectURL æ”¯æŒ', 'success');
            } else {
                log('âŒ URL.createObjectURL ä¸æ”¯æŒ', 'error');
            }
            
            if (typeof FileReader !== 'undefined') {
                log('âœ… FileReader API æ”¯æŒ', 'success');
            } else {
                log('âŒ FileReader API ä¸æ”¯æŒ', 'error');
            }
        }

        function testBrowserDownload() {
            if (testRecords.length === 0) {
                log('âŒ è¯·å…ˆç”Ÿæˆæµ‹è¯•æ•°æ®', 'error');
                return;
            }

            try {
                log('ğŸŒ å¼€å§‹æµ‹è¯•æµè§ˆå™¨ä¸‹è½½...');
                
                // ç”Ÿæˆæ–‡ä»¶å
                const now = new Date();
                const mmddyyyy = `${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getFullYear()}`;
                const filename = `${mmddyyyy}_TrackingNumber_Test.csv`;
                
                // ç”Ÿæˆ CSV å†…å®¹
                const csvContent = "æ—¶é—´,å¿«é€’,å¤„ç†å\n" + testRecords.map(r => `"${r.time}","${r.mode}","${r.out}"`).join("\n");
                
                log(`ğŸ“„ ç”Ÿæˆæ–‡ä»¶: ${filename}`);
                log(`ğŸ“Š å†…å®¹é¢„è§ˆ: ${csvContent.substring(0, 100)}...`);
                
                // æ·»åŠ  BOM ä»¥ç¡®ä¿ UTF-8 ç¼–ç æ­£ç¡®
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                
                // åˆ›å»º Blob
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                log(`ğŸ“¦ Blob åˆ›å»ºæˆåŠŸ, å¤§å°: ${blob.size} å­—èŠ‚`, 'success');
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                // æ·»åŠ åˆ° DOM å¹¶è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    log('ğŸ—‘ï¸ ä¸‹è½½é“¾æ¥å·²æ¸…ç†', 'info');
                }, 1000);
                
                log('âœ… æµè§ˆå™¨ä¸‹è½½æµ‹è¯•å®Œæˆï¼è¯·æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤¹', 'success');
                
            } catch (error) {
                log(`âŒ æµè§ˆå™¨ä¸‹è½½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('æµè§ˆå™¨ä¸‹è½½é”™è¯¯:', error);
            }
        }

        async function testCapacitorExport() {
            if (testRecords.length === 0) {
                log('âŒ è¯·å…ˆç”Ÿæˆæµ‹è¯•æ•°æ®', 'error');
                return;
            }

            if (!window.Capacitor || !window.Capacitor.Plugins.FileManager) {
                log('âŒ Capacitor FileManager æ’ä»¶ä¸å¯ç”¨ï¼Œå›é€€åˆ°æµè§ˆå™¨ä¸‹è½½', 'error');
                testBrowserDownload();
                return;
            }

            try {
                log('ğŸ“± å¼€å§‹æµ‹è¯• Capacitor å¯¼å‡º...');
                
                // ç”Ÿæˆæ–‡ä»¶åå’Œå†…å®¹
                const now = new Date();
                const mmddyyyy = `${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getFullYear()}`;
                const filename = `${mmddyyyy}_TrackingNumber_Capacitor.csv`;
                const csvContent = "æ—¶é—´,å¿«é€’,å¤„ç†å\n" + testRecords.map(r => `"${r.time}","${r.mode}","${r.out}"`).join("\n");
                
                log(`ğŸ“„ å‡†å¤‡ä¿å­˜æ–‡ä»¶: ${filename}`);
                
                // è¯·æ±‚æƒé™
                log('ğŸ” è¯·æ±‚å­˜å‚¨æƒé™...');
                const permissionResult = await window.Capacitor.Plugins.FileManager.requestPermissions();
                log(`âœ… æƒé™è¯·æ±‚ç»“æœ: ${JSON.stringify(permissionResult)}`, 'success');
                
                // å°è¯•ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹
                try {
                    log('ğŸ“¥ å°è¯•ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹...');
                    const downloadResult = await window.Capacitor.Plugins.FileManager.saveFileToDownloads({
                        filename: filename,
                        content: csvContent
                    });
                    
                    log(`âœ… ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹æˆåŠŸ!`, 'success');
                    log(`ğŸ“ è·¯å¾„: ${downloadResult.path}`, 'success');
                    
                    // å°è¯•æ‰“å¼€åº”ç”¨æ–‡ä»¶å¤¹
                    try {
                        log('ğŸ“‚ å°è¯•æ‰“å¼€åº”ç”¨æ–‡ä»¶å¤¹...');
                        const folderResult = await window.Capacitor.Plugins.FileManager.openAppFolder();
                        log(`âœ… åº”ç”¨æ–‡ä»¶å¤¹æ‰“å¼€æˆåŠŸ: ${JSON.stringify(folderResult)}`, 'success');
                    } catch (folderError) {
                        log(`âš ï¸ æ‰“å¼€åº”ç”¨æ–‡ä»¶å¤¹å¤±è´¥: ${folderError.message}`, 'info');
                    }
                    
                    return;
                    
                } catch (downloadError) {
                    log(`âš ï¸ ä¸‹è½½æ–‡ä»¶å¤¹ä¿å­˜å¤±è´¥: ${downloadError.message}`, 'info');
                    
                    // å°è¯•æ–‡æ¡£æ–‡ä»¶å¤¹
                    log('ğŸ“„ å°è¯•ä¿å­˜åˆ°æ–‡æ¡£æ–‡ä»¶å¤¹...');
                    const docResult = await window.Capacitor.Plugins.FileManager.saveFileToDocuments({
                        filename: filename,
                        content: csvContent
                    });
                    
                    log(`âœ… ä¿å­˜åˆ°æ–‡æ¡£æ–‡ä»¶å¤¹æˆåŠŸ!`, 'success');
                    log(`ğŸ“ è·¯å¾„: ${docResult.path}`, 'success');
                    
                    // å°è¯•æ‰“å¼€åº”ç”¨æ–‡ä»¶å¤¹
                    try {
                        const folderResult = await window.Capacitor.Plugins.FileManager.openAppFolder();
                        log(`âœ… åº”ç”¨æ–‡ä»¶å¤¹æ‰“å¼€æˆåŠŸ: ${JSON.stringify(folderResult)}`, 'success');
                    } catch (folderError) {
                        log(`âš ï¸ æ‰“å¼€åº”ç”¨æ–‡ä»¶å¤¹å¤±è´¥: ${folderError.message}`, 'info');
                    }
                }
                
            } catch (error) {
                log(`âŒ Capacitor å¯¼å‡ºæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('Capacitor å¯¼å‡ºé”™è¯¯:', error);
                
                // å›é€€åˆ°æµè§ˆå™¨ä¸‹è½½
                log('ğŸ”„ å›é€€åˆ°æµè§ˆå™¨ä¸‹è½½...', 'info');
                testBrowserDownload();
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒå¹¶ç”Ÿæˆæµ‹è¯•æ•°æ®
        window.onload = function() {
            log('ğŸš€ å¯¼å‡ºåŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
            setTimeout(() => {
                testEnvironment();
                generateTestData();
            }, 500);
        };
    </script>
</body>
</html>